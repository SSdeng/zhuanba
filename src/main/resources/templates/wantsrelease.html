<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>求购发布</title>

    <link rel="stylesheet" type="text/css" href="../css/release.css">
    <link rel="stylesheet" type="text/css" href="../css/header.css">

<body>
    <div class="dingbu">
        <div class="denglu-font top">
            <a href="#" id="dingbuhome"><img src="../images/logo.jpg"></a>
            <div class="denglu-font2 top">
                <a href="#" id="uname">zyl</a>
                <a href="login.html" id="login_logout">登录</a>

            </div>
        </div>

    </div>

    <div class="list-1">
        <ul class="list-ul-2" style="position: relative;right: 190px;">
            <div class="img"><img src="../images/logo1.jpg" width="55px" height="55px" class="img-logo" /></div>

            <li th:each="catagory:${catagories}">
                <a href="login.html" th:text="catagory.name">123</a>
            </li>

        </ul>
    </div>

    <div id="app"><br><br>
        <div class="header">
            <span>
                <h2 style="position: relative;left: 150px;">求购发布</h2>
            </span>
        </div>
        <br><br>
        <div class="content">
            <table>
                <form id="form1" enctype="multipart/form-data">
                    <tr>
                        <td class="text-right">请选择求购的商品图片</td>
                        <td class="content_right">
                            <a href="javascript:;" class="file">
                                <input id="chooseimage" type="file" accept="image/png,image/gif,image/jpg,image/jpeg">
                                <img id="showimage" class="showimage" src="../images/addimage.png">
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-right">求购的商品名称</td>
                        <td class="content_right"><input class="itemname" id="itemname" placeholder="请输入商品名称" required>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-right">求购的商品描述</td>
                        <td class="content_right"><textarea class="description" rows="5" id="description" type="text"
                                placeholder="请输入商品描述"></textarea>
                            <!-- <input class="description" id="password" type="text" placeholder="请输入商品描述"></td> -->
                    </tr>
                    <tr>
                        <td class="text-right">新旧要求</td>
                        <td class="content_right"><input class="level" id="level" type="range" min="1" max="10"
                                value="10" title="10" oninput="changelabel()" width="200px">
                            <p id="levellabel">全新</p>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-right">价格</td>
                        <td class="content_right"><input class="price" id="price" type="number" required></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td class="content_right"><button class="btn btn-info" id="submit">立即提交</button></td>
                    </tr>
                </form>
            </table>
        </div>
    </div>
</body>
<script src="../jquery/jquery2.1.4.js"></script>
<script src="../layer/layer.js"></script>
<script>

    $(function () {

        $("#chooseimage").change(function () {
            var file = document.getElementById("chooseimage");
            $("#showimage").attr("src", getObjectURL($("#chooseimage")[0].files[0]));
        });

        $("#price").change(function () {
            if (checkPrice() == false) {
                layer.msg("请输入正确的价格");
                $(this).val("");
            }
        });

        $("#count").change(function () {
            if (checkCount() == false) {
                layer.msg("请输入正确的物品数量");
                $(this).val("");
            }
        });
        $("#category").change(function () {
            console.log($($(this).find('option:selected')).attr('id'))
            console.log($(this).val());
        });

        $("#submit").click(function () {
            var itemId = 0;
            var userId = localStorage.getItem("userId");
            var itemname = $("#itemname").val();
            var categoryId = $($("#category").find('option:selected')).attr('id');
            var description = $("#description").val();
            var level = $("#level").val();
            var price = $("#price").val();
            var formdata = new FormData($("#chooseimage")[0]);

            if (checkName() && checkPrice() && checkCount) {
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    url: "/api/wants/release?userId=" + userId,
                    data: {
                        "name": itemname,
                        "description": description,
                        "level": level,
                        "price": price,
                    },
                    success: function (data) {
                        if (data.code == 0) {
                            itemId = data.data.itemId;
                        } else {
                            alert(data.msg);
                        }
                    },
                    error: function () {

                    }


                });
                if (itemId != 0) {
                    $.ajax({
                        url: "/api/item/upload?itemId=" + itemId,
                        type: 'POST',
                        data: formData,
                        async: false,
                        success: function (data) {

                        },
                        cache: false,
                        contentType: false,
                        processData: false
                    });
                }

            }
            else {
                return;
            }

        });

        // $("form#data").submit(function () {
        //     var userId = localStorage.getItem("userId");
        //     var itemname = $("#itemname").val();
        //     var description = $("#description").val();
        //     var level = $("#level").val();
        //     var price = $("#price").val();
        //     var count = $("#count").val();

        //     if (checkName() && checkPrice() && checkCount) {
        //         $.ajax({
        //             type: "POST",
        //             dataType: "json",
        //             url: "/api/item/release",
        //             data: {
        //                 "userId": userId,
        //                 "itemname": itemname,
        //                 "description": description,
        //                 "level": level,
        //                 "price": price,
        //                 "count": count
        //             },
        //             success: function (data) {
        //                 if (data.code == 0) {
        //                     itemId = data.data.itemId;
        //                 } else {
        //                     alert(data.msg);
        //                 }
        //             },
        //             error: function () {

        //             }
        //         });
        //     }
        //     else {
        //         return;
        //     }
        // });

        // $("form#file").submit(function () {
        //     var formdata = new FormData($(this)[0]);

        //     $.ajax({
        //         url: "/api/item/upload",
        //         type: 'POST',
        //         data: formData,
        //         async: false,
        //         success: function (data) {
        //             alert(data)
        //         },
        //         cache: false,
        //         contentType: false,
        //         processData: false
        //     });
        // });




    });

    function search() {
        console.log($("#searchText").val());
        var data = { "searchInfo": $("#searchText").val() };
        $.ajax({
            url: "/api/item/search",
            data: JSON.stringify(data),
            type: "POST",
            contentType: "application/json",
            dataType: "json",
            traditional: true
        })
    }
    var login_logout = $("#login_logout");
    function load_data() {
        var theme = localStorage.getItem("username");
        var userId = localStorage.getItem("userId");
        if (theme == null || theme == "") {
            login_logout.innerText = "登录"
            $("#uname").text('');
        } else {
            login_logout.innerText = "退出"
            $("#uname").text(theme);
            $("#uname").attr("href","/api/user/info?userId="+userId);
        }
    }

    function changelabel() {
        var level = $("#level").val();
        if (level == 10) {
            $("#levellabel").text("全新");
        } else {
            $("#levellabel").text(level + "成新");
        }
    };
    function checkName() {
        var itemName = $("#itemname").val();
        if (itemName.length < 2) {
            return false;
        } else {
            return true;
        }
    }

    function checkPrice() {
        var price = $("#price").val() * 1;
        if (price == null || price == "" || price <= 0) {
            return false;
        }
        else {
            $("#price").val(price.toFixed(2));
        }
    }

    function checkCount() {
        var count = $("#count").val();
        if (count == null || count == "" || count <= 0) {
            return false;
        } else {
            $("#count").val(Math.trunc(count));
            return true;
        }
    }


    function checkName() {
        var itemName = $("#itemname").val();
        if (itemName.length < 2) {
            return false;
        } else {
            return true;
        }
    }

    function getObjectURL(file) {
        var url = null
        if (window.createObjectURL != undefined) { // basic    
            url = window.createObjectURL(file)
        } else if (window.URL != undefined) { // mozilla(firefox)    
            url = window.URL.createObjectURL(file)
        } else if (window.webkitURL != undefined) { // webkit or chrome    
            url = window.webkitURL.createObjectURL(file)
        }
        return url;
    }


</script>

</html>